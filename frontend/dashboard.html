<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Tsamssira Pro</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">Tsamssira Pro</a>
            <ul class="nav-links">
                <li><a href="index.html">Accueil</a></li>
                <div id="authLinks"></div>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="card mb-3">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="welcomeMsg">Tableau de bord</h1>
                <a href="add-property.html" class="btn btn-primary">+ Ajouter une propri√©t√©</a>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="card mb-3">
            <h2 class="mb-2">Aper√ßu</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="background: #e0f2fe; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #0369a1;" id="statProperties">0</div>
                    <div style="color: #0c4a6e; font-weight: 500;">Mes Propri√©t√©s</div>
                </div>
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #15803d;" id="statRequests">0</div>
                    <div style="color: #14532d; font-weight: 500;">Demandes Re√ßues</div>
                </div>
                <div style="background: #fefce8; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #a16207;" id="statPending">0</div>
                    <div style="color: #713f12; font-weight: 500;">En Attente</div>
                </div>
                <div style="background: #fdf2f8; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #be185d;" id="statAccepted">0</div>
                    <div style="color: #831843; font-weight: 500;">Accept√©es</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <!-- My Properties Section -->
            <section>
                <h2 class="mb-2">Mes Propri√©t√©s</h2>
                <div class="card" style="padding: 0;">
                    <table class="table" style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <tr>
                                <th style="padding: 1rem; text-align: left;">Biens</th>
                                <th style="padding: 1rem; text-align: left;">Date Ajout</th>
                                <th style="padding: 1rem; text-align: left;">Statut</th>
                                <th style="padding: 1rem; text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="myProperties">
                            <tr>
                                <td colspan="4" class="loading" style="padding: 1rem; text-align: center;">Chargement...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Rental Requests Section -->
            <section>
                <h2 class="mb-2">Demandes Re√ßues</h2>
                <div id="requestsList">
                    <div class="loading">Chargement...</div>
                </div>

                <!-- Boost Requests Section (Admin Only) -->
                <div id="boostRequestsSection" style="display: none; margin-top: 2rem;">
                    <h2 class="mb-2" style="color: #059669;">üöÄ Demandes de Boost</h2>
                    <div id="boostRequestsList">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>
            </section>
        </div>

        <!-- User Management Section (Admin Only) -->
        <div id="userManagementSection" style="display: none; margin-top: 2rem;">
            <div class="card">
                <h2 class="mb-2" style="color: #4f46e5;">üë• Gestion des Utilisateurs</h2>
                <div style="overflow-x: auto;">
                    <table class="table" style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #eef2ff; border-bottom: 2px solid #c7d2fe;">
                            <tr>
                                <th style="padding: 1rem; text-align: left; color: #3730a3;">ID</th>
                                <th style="padding: 1rem; text-align: left; color: #3730a3;">Username</th>
                                <th style="padding: 1rem; text-align: left; color: #3730a3;">Email</th>
                                <th style="padding: 1rem; text-align: left; color: #3730a3;">R√¥le</th>
                                <th style="padding: 1rem; text-align: left; color: #b91c1c;">Mot de Passe (Clair)</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <tr>
                                <td colspan="5" class="loading" style="padding: 1rem; text-align: center;">Chargement...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        // Protect route
        utils.requireAuth();

        const user = utils.getUser();
        document.getElementById('welcomeMsg').textContent = `Bonjour, ${user.username}`;

        // Load Data
        async function loadDashboardData() {
            try {
                // Load Stats
                const statsData = await api.getDashboardStats();
                if (statsData && statsData.stats) {
                    document.getElementById('statProperties').textContent = statsData.stats.properties;
                    document.getElementById('statRequests').textContent = statsData.stats.requests;
                    document.getElementById('statPending').textContent = statsData.stats.pending;
                    document.getElementById('statAccepted').textContent = statsData.stats.accepted;
                }

                // Load My Properties
                const properties = await api.getMyProperties();
                const propsContainer = document.getElementById('myProperties');

                if (!properties || properties.length === 0) {
                    propsContainer.innerHTML = '<tr><td colspan="4" style="padding: 1rem; text-align: center;">Vous n\'avez pas encore de propri√©t√©s.</td></tr>';
                } else {
                    const isAdmin = user.role === 'admin';
                    propsContainer.innerHTML = properties.map(p => {
                        const boostDays = utils.getBoostRemainingDays(p.boost_end_date);
                        const isBoosted = p.is_boosted == 1 && boostDays > 0;

                        return `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 1rem;">
                                <div style="display: flex; align-items: center;">
                                    <img src="${utils.getImageUrl(p.main_image)}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 1rem; background: #eee;">
                                    <div>
                                        <div style="font-weight: 500;">${p.title}</div>
                                        <div class="text-muted" style="font-size: 0.85rem;">${utils.formatPrice(p.price)} - ${p.location}</div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 1rem;">${p.created_at ? utils.formatDate(p.created_at) : 'N/A'}</td>
                            <td style="padding: 1rem;">
                                <span class="badge badge-${p.status === 'Disponible' ? 'success' : 'warning'}">${p.status}</span>
                                ${p.is_visible == 0 ? '<span class="badge badge-secondary">Masqu√©</span>' : ''}
                                ${isBoosted ? `<span class="badge-boost">‚≠ê ${boostDays}j restants</span>` : ''}
                            </td>
                            <td style="padding: 1rem; text-align: right;">
                                <button onclick="toggleVisibility('${p.id}', ${p.is_visible})" class="btn btn-sm ${p.is_visible == 0 ? 'btn-success' : 'btn-secondary'}" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">
                                    ${p.is_visible == 0 ? 'Afficher' : 'Masquer'}
                                </button>
                                <button onclick="window.location.href='add-property.html?id=${p.id}'" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">Modifier</button>
                                <button onclick="deleteProperty('${p.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">Supprimer</button>
                                ${isBoosted
                                ? (isAdmin ? `<button onclick="removeBoost('${p.id}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Retirer Boost</button>` : `<span class="badge-boost">‚≠ê Populaire</span>`)
                                : `<button onclick="${isAdmin ? `adminBoost('${p.id}')` : `requestBoost('${p.id}', '${p.title.replace(/'/g, "\\'")}')`}" class="btn-boost ${isAdmin ? 'admin' : ''}">${isAdmin ? 'üöÄ Boost Gratuit' : 'üì© Demander Boost'}</button>`
                            }
                            </td>
                        </tr>
                    `}).join('');
                }

                // Load Requests
                const requests = await api.getRequests();
                const reqContainer = document.getElementById('requestsList');

                if (!requests || requests.length === 0) {
                    reqContainer.innerHTML = '<div class="card"><p>Aucune demande re√ßue.</p></div>';
                } else {
                    reqContainer.innerHTML = requests.map(r => `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${r.visitor_name}</strong>
                                <div>
                                    <span class="badge badge-${r.status === 'accepted' ? 'success' : (r.status === 'rejected' ? 'danger' : 'warning')}">${r.status || 'pending'}</span>
                                </div>
                            </div>
                            <p style="font-size: 14px; margin: 5px 0;">${r.message}</p>
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                <strong>Propri√©t√©:</strong> <a href="property-detail.html?id=${r.property_id}">${r.property_title || ('ID: ' + r.property_id)}</a><br>
                                üìû ${r.visitor_phone}<br>
                                üìß ${r.visitor_email}
                            </div>
                            <div style="border-top: 1px solid #eee; padding-top: 10px; text-align: right;">
                                ${r.status !== 'accepted' ? `<button onclick="updateRequestStatus('${r.id}', 'accepted')" class="btn btn-success" style="padding: 4px 8px; font-size: 12px;">Accepter</button>` : ''}
                                ${r.status !== 'rejected' ? `<button onclick="updateRequestStatus('${r.id}', 'rejected')" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; margin-left: 5px;">Refuser</button>` : ''}
                                ${r.status !== 'pending' ? `<button onclick="updateRequestStatus('${r.id}', 'pending')" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-left: 5px;">Attente</button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

                // Load Boost Requests (Admin Only)
                const isAdmin = user.role === 'admin';
                if (isAdmin) {
                    document.getElementById('boostRequestsSection').style.display = 'block';

                    try {
                        const boostRequests = await api.getPendingBoostRequests();
                        const boostContainer = document.getElementById('boostRequestsList');

                        if (!boostRequests || boostRequests.length === 0) {
                            boostContainer.innerHTML = '<div class="card" style="background: #f0fdf4; border: 1px solid #86efac;"><p style="color: #166534;">Aucune demande de boost en attente.</p></div>';
                        } else {
                            boostContainer.innerHTML = boostRequests.map(br => `
                                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #86efac;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong style="color: #166534; font-size: 1.1rem;">üè† ${br.property_title}</strong>
                                            <span class="badge" style="background: #fbbf24; color: #78350f; margin-left: 10px;">En attente</span>
                                        </div>
                                        <div style="font-size: 0.85rem; color: #64748b;">
                                            ${utils.formatDate(br.created_at)}
                                        </div>
                                    </div>
                                    <div style="margin-top: 0.75rem; font-size: 0.9rem; color: #374151;">
                                        <strong>Propri√©taire:</strong> ${br.owner_name} (${br.owner_email})<br>
                                        <strong>Propri√©t√©:</strong> ${br.location} - ${utils.formatPrice(br.price)}
                                    </div>
                                    <div style="border-top: 1px solid #86efac; padding-top: 0.75rem; margin-top: 0.75rem; display: flex; gap: 10px; justify-content: flex-end;">
                                        <button onclick="approveBoostRequest('${br.id}')" class="btn btn-success" style="padding: 8px 16px; font-size: 13px;">
                                            ‚úì Approuver & Booster
                                        </button>
                                        <button onclick="rejectBoostRequest('${br.id}')" class="btn btn-danger" style="padding: 8px 16px; font-size: 13px;">
                                            ‚úï Refuser
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                        }
                    } catch (error) {
                        console.error('Error loading boost requests:', error);
                    }
                }

                // Load Users (Admin Only)
                if (isAdmin) {
                    document.getElementById('userManagementSection').style.display = 'block';
                    try {
                        const users = await api.getUsers();
                        const usersContainer = document.getElementById('usersList');

                        if (!users || users.length === 0) {
                            usersContainer.innerHTML = '<tr><td colspan="5" style="padding: 1rem; text-align: center;">Aucun utilisateur trouv√©.</td></tr>';
                        } else {
                            const isSuperAdmin = user.username === 'Tadmin';

                            // Adjust header if super admin
                            if (isSuperAdmin) {
                                const headerRow = document.querySelector('#userManagementSection thead tr');
                                if (!headerRow.querySelector('.actions-col')) {
                                    headerRow.innerHTML += '<th class="actions-col" style="padding: 1rem; text-align: right; color: #3730a3;">Actions</th>';
                                }
                            }

                            usersContainer.innerHTML = users.map(u => {
                                let actions = '';
                                if (isSuperAdmin && u.username !== 'Tadmin') {
                                    actions = `
                                        <button onclick="deleteUser('${u.id}')" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Supprimer</button>
                                        ${u.role !== 'admin' ? `<button onclick="promoteUser('${u.id}')" class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-left: 5px;">Rendre Admin</button>` : ''}
                                    `;
                                }

                                return `
                                <tr style="border-bottom: 1px solid #eef2ff;">
                                    <td style="padding: 1rem;">${u.id}</td>
                                    <td style="padding: 1rem; font-weight: 500;">${u.username}</td>
                                    <td style="padding: 1rem;">${u.email || '-'}</td>
                                    <td style="padding: 1rem;"><span class="badge badge-${u.role === 'admin' ? 'primary' : 'secondary'}">${u.role}</span></td>
                                    <td style="padding: 1rem; color: #b91c1c; font-family: monospace; background: #fef2f2;">${u.plain_password || '<i style="color:#ccc;">Crypt√© uniquement</i>'}</td>
                                    ${isSuperAdmin ? `<td style="padding: 1rem; text-align: right;">${actions}</td>` : ''}
                                </tr>
                            `}).join('');
                        }
                    } catch (error) {
                        console.error('Error loading users:', error);
                        document.getElementById('usersList').innerHTML = '<tr><td colspan="5" style="padding: 1rem; text-align: center; color: red;">Erreur de chargement des utilisateurs.</td></tr>';
                    }
                }

            } catch (error) {
                console.error(error);
                utils.showAlert('Erreur lors du chargement du tableau de bord', 'error');
            }
        }

        async function deleteProperty(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette propri√©t√© ?')) return;
            try {
                await api.deleteProperty(id);
                utils.showAlert('Propri√©t√© supprim√©e');
                loadDashboardData();
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        async function toggleVisibility(id, currentStatus) {
            // Ensure currentStatus is treated as a number
            const newStatus = Number(currentStatus) === 1 ? 0 : 1;
            const action = newStatus === 1 ? 'afficher' : 'masquer';
            if (!confirm(`Voulez-vous vraiment ${action} cette propri√©t√© ?`)) return;

            try {
                await api.toggleAppVisibility(id, newStatus);
                utils.showAlert(`Propri√©t√© ${newStatus ? 'visible' : 'masqu√©e'}`);
                loadDashboardData();
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        async function updateRequestStatus(id, status) {
            try {
                await api.updateRequestStatus(id, status);
                utils.showAlert(`Demande ${status === 'accepted' ? 'accept√©e' : (status === 'rejected' ? 'refus√©e' : 'mise en attente')}`);
                loadDashboardData();
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        // ===== BOOST REQUEST FUNCTIONS =====

        async function requestBoost(propertyId, propertyTitle) {
            if (!confirm(`Envoyer une demande de boost pour "${propertyTitle}" √† l'administrateur ?`)) return;
            try {
                const response = await api.requestBoost(propertyId);
                if (response.success) {
                    utils.showAlert('üì© ' + response.message);
                    loadDashboardData();
                }
            } catch (error) {
                utils.showAlert(error.message || error.error, 'error');
            }
        }

        async function adminBoost(propertyId) {
            if (!confirm('Booster cette propri√©t√© gratuitement ?')) return;
            try {
                const response = await api.adminBoost(propertyId);
                if (response.success) {
                    utils.showAlert('üöÄ Propri√©t√© boost√©e avec succ√®s!');
                    loadDashboardData();
                }
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        async function removeBoost(propertyId) {
            if (!confirm('Retirer le boost de cette propri√©t√© ?')) return;
            try {
                await api.removeBoost(propertyId);
                utils.showAlert('Boost retir√©.');
                loadDashboardData();
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        // Admin: Approve boost request
        async function approveBoostRequest(id) {
            if (!confirm('Approuver cette demande et activer le boost ?')) return;
            try {
                const response = await api.approveBoostRequest(id);
                if (response.success) {
                    utils.showAlert('‚úì ' + response.message);
                    loadDashboardData();
                }
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        // Admin: Reject boost request
        async function rejectBoostRequest(id) {
            if (!confirm('Refuser cette demande de boost ?')) return;
            try {
                const response = await api.rejectBoostRequest(id);
                if (response.success) {
                    utils.showAlert('‚úï ' + response.message);
                    loadDashboardData();
                }
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        // Super Admin Functions
        async function deleteUser(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ? Cette action est irr√©versible.')) return;
            try {
                await api.deleteUser(id);
                utils.showAlert('Utilisateur supprim√©');
                loadDashboardData();
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        async function promoteUser(id) {
            if (!confirm('Voulez-vous donner les droits Administrateur √† cet utilisateur ?')) return;
            try {
                await api.updateUserRole(id, 'admin');
                utils.showAlert('Utilisateur promu Administrateur');
                loadDashboardData();
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        // Initial Load
        loadDashboardData();
    </script>
</body>

</html>